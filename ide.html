<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Guesslang + Pyodide + Monaco + HTML Preview</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js"></script>
<script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
<style>
  body, html {
    margin:0; padding:0; height: 100vh; display: flex; flex-direction: column; background:#1e1e1e; color:#ccc;
    font-family: monospace;
  }
  #info {
    padding: 5px 10px; background: #333;
  }
  #main {
    flex: 1; display: flex; flex-direction: row; height: calc(100vh - 80px);
    overflow: hidden;
  }
  #editor {
    flex: 1; height: 100%;
  }
  #previewContainer {
    width: 50%; height: 100%; border-left: 2px solid #444;
    display: flex; flex-direction: column;
  }
  #preview {
    flex: 1; border: none; background: white;
  }
  #terminal {
    height: 150px; background: black; color: white; padding: 10px; overflow-y: auto; font-family: monospace;
  }
  #runBtn {
    padding: 10px 15px; font-size: 1.1em; cursor: pointer; background: #007acc; border: none; color: white;
  }
  #runBtn:hover {
    background: #005f99;
  }
</style>
</head>
<body>

<div id="info">Tahmin edilen dil: <span id="langDisplay">Yükleniyor...</span></div>
<div id="main">
  <div id="editor"></div>
  <div id="previewContainer">
    <iframe id="preview" sandbox="allow-scripts allow-same-origin"></iframe>
    <div id="terminal">Çıktı burada...</div>
    <button id="runBtn">Çalıştır</button>
  </div>
</div>

<script>
  let pyodide;
  let guesslangReady = false;
  let editor;
  let lastLang = "plaintext";

  async function initPyodide() {
    pyodide = await loadPyodide();
    await pyodide.loadPackage('micropip');
    await pyodide.runPythonAsync(`
import micropip
await micropip.install("guesslang")
from guesslang import Guess
guess = Guess()
    `);
    guesslangReady = true;
    document.getElementById('langDisplay').textContent = "Hazır, kod yaz!";
    console.log("🐍 Pyodide ve Guesslang yüklendi.");
  }

  // Monaco Editor başlatma
  require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@latest/min/vs' }});
  require(['vs/editor/editor.main'], function() {
    editor = monaco.editor.create(document.getElementById('editor'), {
      value: `<!DOCTYPE html>
<html>
<head><title>Merhaba</title></head>
<body>
<h1>HTML Preview Demo</h1>
<p>Buraya HTML kodunu yazabilirsin.</p>
<script>
  console.log("JS çalıştı!");
</script>
</body>
</html>`,
      language: 'plaintext',
      theme: 'vs-dark',
      automaticLayout: true,
      fontSize: 16,
      minimap: { enabled: false },
    });

    editor.onDidChangeModelContent(debounce(async () => {
      if (!guesslangReady) return;
      const code = editor.getValue();
      if (code.trim().length === 0) {
        updateLanguage("plaintext");
        updatePreview("");
        return;
      }
      try {
        const pyCode = `
result = guess.language_name("""${code.replace(/"""|\\/g, (m) => m === '"""' ? '\\"\\"\\"' : '\\\\')}""")
result
        `;
        const lang = await pyodide.runPythonAsync(pyCode);
        updateLanguage(lang);
        if (lang.toLowerCase() === "html" || lang.toLowerCase() === "javascript" || lang.toLowerCase() === "typescript") {
          updatePreview(code);
          updateTerminal("HTML/JS/TS detected - preview aktif.");
        } else {
          updatePreview("");
          updateTerminal("Preview kapalı - sadece çıktı gösteriliyor.");
        }
      } catch (e) {
        console.error("Guesslang hatası:", e);
        updateLanguage("plaintext");
        updatePreview("");
        updateTerminal("Tahmin hatası, preview kapalı.");
      }
    }, 500));
  });

  function updateLanguage(lang) {
    lastLang = lang.toLowerCase();
    document.getElementById('langDisplay').textContent = lang;
    const monacoLangMap = {
      'python': 'python',
      'javascript': 'javascript',
      'java': 'java',
      'c++': 'cpp',
      'c': 'c',
      'html': 'html',
      'ruby': 'ruby',
      'go': 'go',
      'php': 'php',
      'shell': 'shell',
      'typescript': 'typescript',
      'plaintext': 'plaintext',
    };
    const mLang = monacoLangMap[lastLang] || 'plaintext';
    monaco.editor.setModelLanguage(editor.getModel(), mLang);
  }

  function updatePreview(code) {
    const preview = document.getElementById('preview');
    if (!code) {
      preview.srcdoc = "<html><body><i>Preview yok</i></body></html>";
    } else {
      preview.srcdoc = code;
    }
  }

  function updateTerminal(text) {
    document.getElementById('terminal').textContent = text;
  }

  function debounce(fn, delay) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  }

  document.getElementById('runBtn').addEventListener('click', async () => {
    const code = editor.getValue();
    const term = document.getElementById('terminal');
    term.textContent = 'Çalışıyor... ⏳';

    if (!guesslangReady) {
      term.textContent = 'Pyodide veya Guesslang hazır değil.';
      return;
    }

    try {
      if (lastLang === 'python') {
        let output = await pyodide.runPythonAsync(code);
        if (output === undefined || output === null || output === '') output = '(Çıktı yok)';
        term.textContent = output;
        updatePreview(""); // Python için preview kapalı
      }
      else if (lastLang === 'javascript' || lastLang === 'typescript') {
        try {
          let result = eval(code);
          if (result === undefined || result === null) result = '(Çıktı yok)';
          term.textContent = result.toString();
          updatePreview(code); // JS/TS için preview açık
        } catch (e) {
          term.textContent = 'JS Hatası: ' + e;
          updatePreview("");
        }
      }
      else if (lastLang === 'html') {
        term.textContent = 'HTML - lütfen sağdaki önizlemeyi kontrol et.';
        updatePreview(code); // HTML için preview açık
      }
      else {
        term.textContent = `Bu dil (${lastLang}) için çalıştırma desteklenmiyor.`;
        updatePreview("");
      }
    } catch (e) {
      term.textContent = 'Hata: ' + e;
      updatePreview("");
    }
  });

  initPyodide();
</script>

</body>
</html>
